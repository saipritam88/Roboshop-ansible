---
- name: setup payment server
  hosts: payment
  become: yes

  tasks:
  - name: install python packages
    ansible.builtin.dnf:
        name: "{{ item }}"
        state: present
    loop:
        - python3
        - python3-pip
        - python3-devel
  
- name: add payment user
  ansible.builtin.user:
    name: roboshop
    shell: /sbin/nologin
    state: present

- name: delete payment app directory
  ansible.builtin.file:
     path: /app
     state: absent

- name: create payment app directory
  ansible.builtin.file:
    path: /app
    state: directory
    
- name: download payment application code
  ansible.builtin.get_url:
    url: https://roboshop-artifacts.s3.amazonaws.com/payment-v3.zip
    dest: /tmp/payment.zip

- name: unzip payment application code
  ansible.builtin.unarchive:  
    src: /tmp/payment.zip
    dest: /app
    remote_src: yes

- name: install python dependencies
  ansible.builtin.pip:
    requirements: /app/requirements.txt
    executable: pip3
    args:
      chdir: /app

- name: copy payment systemd service file
  ansible.builtin.copy:
    src: payment.service
    dest: /etc/systemd/system/payment.service



